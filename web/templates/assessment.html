{% extends "base.html" %}

{% block title %}{{ dimension.name }} - Assessment{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Progress Header -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">
                    <i class="fas fa-tasks me-2"></i>
                    Dimension {{ dimension_index + 1 }} of {{ total_dimensions }}
                </span>
                <span class="badge bg-primary">{{ progress }}% Complete</span>
            </div>
            <div class="progress" style="height: 8px;">
                <div class="progress-bar" style="width: {{ progress }}%"></div>
            </div>
        </div>
    </div>

    <!-- Dimension Header -->
    <div class="card mb-4">
        <div class="card-body">
            <h2 class="mb-2">
                {% if dimension_id == 'data_maturity' %}
                <i class="fas fa-database me-2 text-primary"></i>
                {% elif dimension_id == 'technology_infrastructure' %}
                <i class="fas fa-server me-2 text-primary"></i>
                {% elif dimension_id == 'process_operations' %}
                <i class="fas fa-cogs me-2 text-primary"></i>
                {% elif dimension_id == 'workforce_culture' %}
                <i class="fas fa-users me-2 text-primary"></i>
                {% elif dimension_id == 'governance_compliance' %}
                <i class="fas fa-shield-alt me-2 text-primary"></i>
                {% endif %}
                {{ dimension.name }}
            </h2>
            <p class="text-muted mb-0">{{ dimension.description }}</p>
        </div>
    </div>

    <!-- Questions Form -->
    <form id="dimensionForm">
        {% for question in dimension.questions %}
        <div class="question-card" data-question-id="{{ question.id }}">
            <div class="d-flex mb-3">
                <span class="badge bg-secondary me-2">Q{{ loop.index }}</span>
                <h5 class="mb-0">{{ question.text }}</h5>
            </div>

            <div class="options-container">
                {% for option in question.options %}
                <button type="button"
                        class="option-button"
                        data-question="{{ question.id }}"
                        data-value="{{ option.value }}">
                    <span class="option-value">{{ option.value }}</span>
                    {{ option.label }}
                </button>
                {% endfor %}
            </div>
        </div>
        {% endfor %}

        <!-- Navigation -->
        <div class="d-flex justify-content-between mt-4">
            {% if dimension_index > 0 %}
            <a href="#" onclick="history.back(); return false;" class="btn btn-patriot-outline">
                <i class="fas fa-arrow-left me-2"></i>Previous
            </a>
            {% else %}
            <div></div>
            {% endif %}

            <button type="submit" class="btn btn-patriot btn-lg" id="nextBtn">
                {% if dimension_index + 1 == total_dimensions %}
                <i class="fas fa-chart-bar me-2"></i>View Results
                {% else %}
                Next Dimension<i class="fas fa-arrow-right ms-2"></i>
                {% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Track responses
    const responses = {};

    // Option selection
    document.querySelectorAll('.option-button').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const questionId = this.dataset.question;
            const value = parseInt(this.dataset.value);

            // Deselect other options for this question
            document.querySelectorAll(`[data-question="${questionId}"]`).forEach(btn => {
                btn.classList.remove('selected');
            });

            // Select this option
            this.classList.add('selected');

            // Store response
            responses[questionId] = value;

            // Auto-scroll to next question (optional)
            const currentCard = this.closest('.question-card');
            const nextCard = currentCard.nextElementSibling;
            if (nextCard && nextCard.classList.contains('question-card')) {
                nextCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        });
    });

    // Form submission
    document.getElementById('dimensionForm').addEventListener('submit', function(e) {
        e.preventDefault();

        // Check all questions are answered
        const questionCards = document.querySelectorAll('.question-card');
        let allAnswered = true;
        let firstUnanswered = null;

        questionCards.forEach(card => {
            const questionId = card.dataset.questionId;
            if (!responses[questionId]) {
                allAnswered = false;
                card.style.borderLeft = '4px solid #dc3545';
                if (!firstUnanswered) firstUnanswered = card;
            } else {
                card.style.borderLeft = '4px solid #28a745';
            }
        });

        if (!allAnswered) {
            firstUnanswered.scrollIntoView({ behavior: 'smooth', block: 'center' });
            alert('Please answer all questions before continuing.');
            return;
        }

        // Submit responses
        fetch('/submit_dimension', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ responses: responses })
        })
        .then(response => response.json())
        .then(data => {
            if (data.redirect) {
                window.location.href = data.redirect;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    });
</script>
{% endblock %}
